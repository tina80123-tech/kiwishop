<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ¸ æ—¥æœ¬ä»£è³¼è²¡å‹™ç¸½è¦½ - Premium UI (é›²ç«¯åŒæ­¥)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #f9821e;
            --primary-dark: #e06f12;
            --accent-color: #007bff;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;

            --bg-light: #ffffff;
            --bg-soft: #fff7ed;
            --bg-page: #f4f5f7;
            --text-dark: #333;

            --radius-lg: 18px;
            --radius-md: 12px;
            --radius-sm: 8px;

            --shadow-soft: 0 4px 10px rgba(0,0,0,0.06);
            --shadow-card: 0 6px 18px rgba(0,0,0,0.08);
        }

        body {
            margin: 0;
            padding: 25px;
            background: var(--bg-page);
            font-family: 'Noto Sans TC', sans-serif;
            color: var(--text-dark);
        }

        h1 {
            text-align: center;
            font-size: 2.6em;
            font-weight: 900;
            margin-bottom: 30px;
            color: var(--primary-color);
        }

        /* å¤§å¡ç‰‡ */
        .container {
            max-width: 1350px;
            margin: 0 auto;
            background: var(--bg-light);
            padding: 35px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
        }

        /* å°å¡ç‰‡ */
        .card {
            background: white;
            padding: 28px;
            border-radius: var(--radius-md);
            margin-bottom: 30px;
            box-shadow: var(--shadow-soft);
        }

        /* ç‰¹æ®Šæ©˜è‰²å¡ç‰‡ */
        .card-basic {
            background: linear-gradient(135deg, #fff7e8 0%, #ffe8cc 100%);
            border-left: 6px solid var(--primary-color);
        }

        h3 {
            font-size: 1.4em;
            margin-bottom: 20px;
            font-weight: 800;
            color: var(--primary-color);
        }

        /* è¡¨å–®æ¬„ä½ï¼šPremium UI å¼·åŒ– */
        .form-row {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .form-field {
            flex: 1;
            min-width: 260px;
        }

        label {
            display: block;
            font-size: 1.05em;
            font-weight: 700;
            margin-bottom: 6px;
        }

        input, select {
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: var(--radius-md);
            background: #fff;
            transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(249,130,30,0.25);
            outline: none;
        }

        /* ä¸»æŒ‰éˆ• */
        .primary-btn {
            width: 100%;
            padding: 18px;
            margin-top: 10px;
            background: var(--primary-color);
            border: none;
            color: #fff;
            font-size: 1.25em;
            font-weight: 900;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: 0.2s;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(249,130,30,0.35);
        }
        .primary-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        .primary-btn:active {
            transform: scale(0.97);
        }

        /* æ–°å¢å°å‡º CSV æŒ‰éˆ•æ¨£å¼ */
        .export-btn {
            background: #008856; /* Green for export */
            box-shadow: 0 4px 15px rgba(0, 136, 86, 0.35);
            margin-bottom: 25px; /* Add margin below the button */
        }

        .export-btn:hover {
            background: #007047;
        }

        /* ç·¨è¼¯ï¼åˆªé™¤æŒ‰éˆ• */
        .table-btn {
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            font-size: 0.9em;
            font-weight: 700;
            cursor: pointer;
            border: none;
            color: white;
            margin-right: 5px;
            box-shadow: var(--shadow-soft);
        }
        .edit-btn { background: var(--accent-color); }
        .lock-btn { background: var(--success); }
        .delete-btn { background: var(--danger); }

        /* ç‹€æ…‹æŒ‰éˆ• */
        .status-btn {
            padding: 10px 16px;
            font-size: 1em;
            border-radius: var(--radius-md);
            border: 1px solid #ccc;
            cursor: pointer;
            background: #f2f2f2;
        }
        .status-btn.active-unpaid { background: var(--warning); border-color: #c98700; }
        .status-btn.active-deposit { background: #40b8ad; color: #fff; }
        .status-btn.active-paid { background: var(--success); color: #fff; }

        /* ç‹€æ…‹å¾½ç«  */
        .status-badge {
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 900;
            font-size: 1em;
            color: white;
        }
        .badge-unpaid { background: var(--warning); color: #333; }
        .badge-deposit { background: #40b8ad; }
        .badge-paid { background: var(--success); }

        /* ç¸½è¨ˆå€å¡Š */
        .summary-box {
            display: flex;
            justify-content: space-around;
            gap: 25px;
            padding: 25px;
            border-radius: var(--radius-md);
            background: var(--bg-soft);
            border-left: 6px solid var(--primary-color);
            margin-bottom: 35px;
        }
        .summary-item strong {
            font-size: 1.7em;
            display: block;
            margin-top: 8px;
        }

        /* è¡¨æ ¼ */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 25px;
            background: #fff;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-card);
            overflow: hidden;
        }
        th {
            background: #f9f9f9;
            padding: 14px;
            font-weight: 800;
        }
        td {
            padding: 14px;
            border-top: 1px solid #eee;
        }

        /* æ‰‹æ©Ÿç‰ˆæå‡å¯è®€æ€§ */
        @media (max-width: 768px) {
            
            /* èª¿æ•´å®¹å™¨èˆ‡é‚Šè· */
            body { padding: 15px; }
            .container { padding: 20px; }
            h1 { font-size: 2em; margin-bottom: 20px; }
            h3 { font-size: 1.3em; }

            /* è¡¨å–®æ¬„ä½èª¿æ•´ */
            input, select { font-size: 1.1em; padding: 14px; }
            .primary-btn { font-size: 1.2em; padding: 18px; }
            .form-field { min-width: 100%; margin-bottom: 15px; }
            .form-row { gap: 0; margin-bottom: 0 !important; }

            /* ç¸½è¨ˆå€å¡Šå †ç–Š */
            .summary-box { flex-direction: column; gap: 15px; }
            .summary-item strong { font-size: 1.5em; }
            
            /* éŸ¿æ‡‰å¼è¡¨æ ¼å„ªåŒ–ï¼šå°‡è¡¨æ ¼è®Šæˆåˆ—è¡¨æ¨£å¼ */
            table, thead, tbody, th, td, tr { 
                display: block; /* æ‰€æœ‰è¡¨æ ¼å…ƒç´ éƒ½è®Šæˆå€å¡Š */
                width: 100%;
                box-sizing: border-box;
            }
            
            thead { display: none; } /* éš±è—åŸæœ¬çš„è¡¨é ­ */
            
            tr {
                margin-bottom: 15px;
                border: 1px solid #ddd;
                border-radius: var(--radius-md);
                overflow: hidden;
            }
            
            td {
                border: none; /* ç§»é™¤å–®å…ƒæ ¼é‚Šæ¡† */
                position: relative;
                padding-left: 45%; /* ç‚ºæ¨™ç±¤é¨°å‡ºç©ºé–“ */
                text-align: right;
                font-size: 1em;
            }
            
            td:last-child {
                border-bottom: none;
            }

            td:before {
                /* ä½¿ç”¨ data-label ä¾†é¡¯ç¤ºæ¬„ä½åç¨± */
                content: attr(data-label);
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 40%;
                padding: 14px 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 700;
                background-color: #f7f7f7;
                border-right: 1px solid #eee;
                color: #555;
            }

            /* ç‰¹æ®Šèª¿æ•´ï¼šæ“ä½œæŒ‰éˆ•å€å¡Šç½®ä¸­ */
            td[data-label="æ“ä½œ"] {
                text-align: center;
                padding-left: 14px;
            }
            td[data-label="æ“ä½œ"]:before {
                display: none;
            }

            /* ç‹€æ…‹æŒ‰éˆ•çµ„çš„æ¨£å¼ä¿®æ­£ */
            .status-btn-group {
                display: flex;
                flex-wrap: wrap;
                justify-content: flex-end; /* é å³å°é½Š */
                gap: 5px;
            }
            .status-btn {
                padding: 8px 12px;
                font-size: 0.9em;
                flex: 1 1 auto;
                min-width: unset;
            }
            .status-badge {
                 margin-right: 0; /* ä¿®æ­£å°é½Š */
            }
        }


        /* ä¿®æ­£æ¬„ä½ä¹‹é–“è·é›¢ä¸è¶³ã€é¿å…å½¼æ­¤é‡ç–Š */
        .form-row {
            margin-bottom: 28px !important;   /* å¢åŠ æ¯æ’ä¸‹æ–¹ç©ºé–“ */
        }

        .form-field {
            margin-bottom: 18px;              /* æ¯å€‹æ¬„ä½åº•éƒ¨å¢åŠ è·é›¢ */
        }

        /* ä¿è­‰å·¦å³æ¬„ä¹‹é–“ä¸æœƒç·Šè²¼ */
        .form-field input,
        .form-field select {
            box-sizing: border-box;
        }

        /* æ—¥æœŸæ¬„ä½é¿å…èˆ‡å³é‚Šæ¬„ä½é»åœ¨ä¸€èµ· */
        input[type="date"] {
            padding-top: 14px;
            padding-bottom: 14px;
        }

        /* å®¢æˆ¶è¨‚å–®å®¹å™¨ */
        .buyer-summary-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        /* åŸºç¤å¡ç‰‡æ¨£å¼ */
        .buyer-box {
            border-left: 6px solid var(--primary-color);
            border-radius: 16px;
            padding: 22px 28px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        /* äº¤éŒ¯èƒŒæ™¯è‰²è®“æ¯å¡Š buyer box æ¸…æ¥šå€åˆ† */
        .buyer-summary-list .buyer-box:nth-child(odd) {
            background: #fff7e8; /* æ·¡æ©˜ */
        }
        
        .buyer-summary-list .buyer-box:nth-child(even) {
            background: #f3f4f6; /* æ·¡ç° */
        }

        .buyer-name {
            margin: 0;
            font-size: 1.35em;
            font-weight: 800;
            color: var(--primary-color);
        }

        .buyer-total {
            font-size: 1.2em;
            margin: 10px 0;
            font-weight: 700;
            color: #444;
        }

        .buyer-items ul {
            margin: 8px 0 5px 0;
            padding-left: 20px;
        }

        .buyer-items li {
            font-size: 1em;
            margin-bottom: 4px;
        }

        /* èª¿æ•´é‚Šæ¡†è®“æ©˜è‰²æ›´æ˜é¡¯ */
        .buyer-box {
            border-left: 6px solid var(--primary-color);
            border-radius: 16px;
            padding: 22px 28px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        /* è¼‰å…¥æç¤º */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-dark);
            flex-direction: column;
            gap: 20px;
        }

    </style>
</head>

<body>
    
    <div id="loading-overlay" style="display: flex;">
        <span>ğŸ”„ æ­£åœ¨å¾é›²ç«¯è¼‰å…¥æˆ–å„²å­˜è³‡æ–™...</span>
        <span id="loading-status" style="font-size: 0.7em; font-weight: normal; color: #666;">è«‹ç¨å€™ã€‚</span>
    </div>

    <h1>ğŸŒ¸ æ—¥æœ¬ä»£è³¼è²¡å‹™ç¸½è¦½ - Premium UI (é›²ç«¯åŒæ­¥)</h1>

    <div class="container">

        <div class="card card-basic">
            <h3>ğŸ“ˆ åŸºæœ¬è¨­å®šï¼ˆåŒ¯ç‡é›²ç«¯æš«å­˜ï¼‰</h3>

            <div class="form-row">
                <div class="form-field">
                    <label>ç•¶æ—¥åŒ¯ç‡ (JPY â†’ TWD)</label>
                    <input type="number" id="rate" step="0.0001" value="0.2250">
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ æ–°å¢ä»£è³¼å“é …</h3>

            <div class="form-row">
                <div class="form-field">
                    <label>è³¼è²·è€…å§“å / ä»£è™Ÿ</label>
                    <input type="text" id="buyer" placeholder="ä¾‹å¦‚ï¼šç‹å°æ˜">
                </div>

                <div class="form-field">
                    <label>å“é …åç¨±</label>
                    <input type="text" id="item" list="itemOptions" placeholder="è¼¸å…¥æˆ–é¸æ“‡" onchange="autoFillPrices(this.value)">
                    <datalist id="itemOptions"></datalist>
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label>è³¼è²·æ—¥æœŸ</label>
                    <input type="date" id="purchaseDate">
                </div>

                <div class="form-field">
                    <label>æ•¸é‡</label>
                    <input type="number" id="quantity" value="1" min="1" oninput="updatePricesOnQuantityChange()">
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label>ä»£è³¼æˆæœ¬ï¼ˆæ—¥åœ“ï¼‰</label>
                    <input type="number" id="costJPY" placeholder="ä¾‹å¦‚ï¼š10000">
                </div>

                <div class="form-field">
                    <label>å”®å‡ºé‡‘é¡ï¼ˆå°å¹£ï¼‰</label>
                    <input type="number" id="priceTWD" placeholder="ä¾‹å¦‚ï¼š3000">
                </div>
            </div>

            <div class="form-row">
                <div class="form-field">
                    <label>é è¨­æ”¶æ¬¾ç‹€æ…‹</label>
                    <select id="isPaid">
                        <option value="unpaid">æœªæ”¶</option>
                        <option value="deposit">å·²æ”¶è¨‚é‡‘</option>
                        <option value="paid">å·²æ”¶å…¨æ¬¾</option>
                    </select>
                </div>
            </div>

            <button class="primary-btn" onclick="addItem()">â• æ–°å¢ç´€éŒ„</button>
        </div>

        <div class="summary-box">
            <div class="summary-item">
                ç¸½æ”¯å‡ºï¼ˆTWDï¼‰<strong id="totalCost">0</strong>
            </div>
            <div class="summary-item">
                ç¸½ç²åˆ©ï¼ˆTWDï¼‰<strong id="totalProfit">0</strong>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“¦ å®¢æˆ¶è¨‚å–®ç¸½é¡èˆ‡æ˜ç´°</h3>
            <div id="buyerSummary" class="buyer-summary-list"></div>
        </div>
        
        <button class="primary-btn export-btn" onclick="exportCSV()">â¬‡ï¸ å°å‡º CSV æª”æ¡ˆ</button>


        <table>
            <thead>
                <tr>
                    <th></th>
                    <th>æ—¥æœŸ</th>
                    <th>è³¼è²·è€…</th>
                    <th>å“é …</th>
                    <th>æ•¸é‡</th>
                    <th>æˆæœ¬ (JPY)</th>
                    <th>åŒ¯ç‡</th>
                    <th>æˆæœ¬ (TWD)</th>
                    <th>å”®åƒ¹ (TWD)</th>
                    <th>è¨‚é‡‘</th>
                    <th>å°¾æ¬¾</th>
                    <th>ç²åˆ©</th>
                    <th>ç‹€æ…‹</th>
                </tr>
            </thead>
            <tbody id="logTableBody"></tbody>
        </table>

    </div>

    <script>
        // ã€è«‹å‹™å¿…ç¢ºèªé€™è¡Œ URL æ­£ç¢ºç„¡èª¤ã€‘
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzB2nLjesCoWjVjmkM07-Nepof5Ec-MrfT3sZT5lKouKnks1gTsRUhQqriaH48o9z-Zmg/exec'; 

        let records = []; 
        let itemPriceCache = {}; 
        
        // å…¨åŸŸè®Šæ•¸ï¼šè¿½è¹¤ç•¶å‰æ­£åœ¨ç·¨è¼¯çš„ ID
        let editingId = null;

        const PAID_STATUSES = {
            unpaid: 'âœ— æœªæ”¶',
            deposit: '50%è¨‚é‡‘',
            paid: 'âœ“ å·²æ”¶å…¨æ¬¾'
        };

        window.onload = function() {
            // ç”±æ–¼ URL å·²ç¢ºèªï¼Œç›´æ¥è¼‰å…¥è³‡æ–™
            loadDataFromSheet();
            document.getElementById('purchaseDate').valueAsDate = new Date();
            
            // ç›£è½åŒ¯ç‡è®Šå‹•ä¸¦å„²å­˜
            document.getElementById('rate').addEventListener('input', function() { saveDataToSheet(); });
        };
        
        // --- é›²ç«¯åŒæ­¥å‡½å¼ ---

        async function loadDataFromSheet() {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-status').textContent = 'æ­£åœ¨å¾ Google Sheets è¼‰å…¥...';
            
            try {
                // ç™¼å‡º GET è«‹æ±‚ï¼Œå¸¶æœ‰ action=get åƒæ•¸
                const response = await fetch(WEB_APP_URL + '?action=get');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                // è¼‰å…¥è³‡æ–™
                records = data.records || [];
                itemPriceCache = data.itemPriceCache || {};
                
                // è¼‰å…¥åŒ¯ç‡
                if (data.rate) document.getElementById('rate').value = data.rate;

                renderTable();
                renderItemDatalist();
                
                document.getElementById('loading-status').textContent = 'è¼‰å…¥å®Œæˆã€‚';

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading-status').innerHTML = `
                    è¼‰å…¥å¤±æ•—ï¼š${error.message}ã€‚è«‹æª¢æŸ¥ Apps Script æ¬Šé™ï¼ˆæ˜¯å¦ç‚ºã€Œä»»ä½•äººã€ï¼‰æˆ–éƒ¨ç½²ç‰ˆæœ¬ã€‚
                `;
            } finally {
                // å»¶é²å¾Œéš±è—ï¼Œè®“ä½¿ç”¨è€…çœ‹åˆ°å®Œæˆè¨Šæ¯
                setTimeout(() => { document.getElementById('loading-overlay').style.display = 'none'; }, 1000);
            }
        }

        async function saveDataToSheet() {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-status').textContent = 'æ­£åœ¨å„²å­˜åˆ° Google Sheets...';
            
            const dataToSave = {
                records: records,
                itemPriceCache: itemPriceCache,
                rate: document.getElementById('rate').value
            };

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSave)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const result = await response.json();
                
                if (result.error) throw new Error(result.error);
                
                document.getElementById('loading-status').textContent = 'å„²å­˜æˆåŠŸï¼';

            } catch (error) {
                console.error('Error saving data:', error);
                document.getElementById('loading-status').innerHTML = `
                    å„²å­˜å¤±æ•—ï¼š${error.message}ã€‚è«‹æª¢æŸ¥ Apps Script æ¬Šé™ï¼ˆæ˜¯å¦ç‚ºã€Œä»»ä½•äººã€ï¼‰æˆ–éƒ¨ç½²ç‰ˆæœ¬ã€‚
                `;
            } finally {
                 // å»¶é²å¾Œéš±è—
                setTimeout(() => { document.getElementById('loading-overlay').style.display = 'none'; }, 1000);
            }
        }

        // --- åŸæœ‰é‚è¼¯å‡½å¼ï¼Œä½†ç¾åœ¨å‘¼å« saveDataToSheet() ---
        
        function renderItemDatalist() {
            const datalist = document.getElementById('itemOptions');
            datalist.innerHTML = '';
            
            const itemNames = Object.keys(itemPriceCache);
            
            itemNames.sort().forEach(item => {
                if (item) { 
                    const option = document.createElement('option');
                    option.value = item;
                    datalist.appendChild(option);
                }
            });
        }
        
        function saveItemPrice(itemName, costJPY, priceTWD, quantity) {
            itemName = itemName.trim();
            if (!itemName || quantity <= 0) return;

            const singleCostJPY = costJPY / quantity;
            const singlePriceTWD = priceTWD / quantity;
            
            itemPriceCache[itemName] = {
                cost: singleCostJPY.toFixed(2),
                price: singlePriceTWD.toFixed(2)
            };

            renderItemDatalist(); 
            saveDataToSheet(); // <--- å„²å­˜åˆ°é›²ç«¯
        }

        // æ•¸é‡è®Šå‹•æ™‚ï¼Œé‡æ–°è¨ˆç®—ç¸½æˆæœ¬å’Œç¸½å”®åƒ¹
        function updatePricesOnQuantityChange() {
            const itemName = document.getElementById('item').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            if (itemPriceCache[itemName]) {
                const { cost, price } = itemPriceCache[itemName];
                
                const newCostJPY = parseFloat(cost) * quantity;
                const newPriceTWD = parseFloat(price) * quantity;
                
                document.getElementById('costJPY').value = newCostJPY.toFixed(2);
                document.getElementById('priceTWD').value = newPriceTWD.toFixed(2);
            }
        }
        
        // é¸æ“‡å“é …æˆ–å®Œæˆè¼¸å…¥æ™‚ï¼Œè‡ªå‹•å¡«å……åƒ¹æ ¼æ¬„ä½
        function autoFillPrices(itemName) {
            const trimmedName = itemName.trim();
            
            if (itemPriceCache[trimmedName]) {
                updatePricesOnQuantityChange(); 
            } else {
                document.getElementById('costJPY').value = '';
                document.getElementById('priceTWD').value = '';
            }
        }
        
        // æ–°å¢å“é …
        function addItem() {
            const item = document.getElementById('item').value.trim(); 
            const quantity = parseInt(document.getElementById('quantity').value); 
            
            if (!item) {
                 alert('è«‹è¼¸å…¥å“é …åç¨±ã€‚');
                 return;
            }

            // 1. å–å¾—å…¶ä»–æ¬„ä½å€¼
            const purchaseDate = document.getElementById('purchaseDate').value; 
            // åŒ¯ç‡å¾ç¨ç«‹æ¬„ä½å–å¾—
            const rate = parseFloat(document.getElementById('rate').value); 
            const buyer = document.getElementById('buyer').value.trim(); 
            const paidStatus = document.getElementById('isPaid').value; 
            const costJPY = parseFloat(document.getElementById('costJPY').value); 
            const priceTWD = parseFloat(document.getElementById('priceTWD').value); 

            if (!purchaseDate || !rate || rate <= 0) {
                 alert('è«‹ç¢ºèªã€Œè³¼è²·æ—¥æœŸã€å’Œã€Œç•¶æ—¥åŒ¯ç‡ã€å·²å¡«å¯«æœ‰æ•ˆæ•¸å€¼ï¼');
                 return;
            }

            if (!buyer || isNaN(quantity) || isNaN(costJPY) || isNaN(priceTWD) || quantity <= 0) {
                alert('è«‹ç¢ºèªæ‰€æœ‰å¿…å¡«æ¬„ä½éƒ½å·²å¡«å¯«æ­£ç¢ºã€‚');
                return;
            }

            // 2. æ ¸å¿ƒè¨ˆç®—é‚è¼¯
            const costTWD = costJPY * rate; 
            const totalSaleTWD = priceTWD;
            const profit = totalSaleTWD - costTWD;
            
            // è¨‚é‡‘è¨ˆç®—ï¼šå‘ä¸‹å–æ•´ (æ¨å»å€‹ä½æ•¸èˆ‡ä¹˜æ³•å¾Œçš„å°æ•¸ä½é‡‘é¡ -> Math.floor(TWD * 0.5))
            const depositTWD = Math.floor(totalSaleTWD * 0.5); 
            const balanceTWD = totalSaleTWD - depositTWD;

            const newRecord = {
                id: Date.now(), 
                purchaseDate: purchaseDate, 
                buyer: buyer, 
                item: item, 
                quantity: quantity,
                costJPY: costJPY.toFixed(2), 
                rate: rate.toFixed(4), 
                costTWD: costTWD.toFixed(2), 
                priceTWD: totalSaleTWD.toFixed(2), 
                depositTWD: depositTWD.toFixed(2), 
                balanceTWD: balanceTWD.toFixed(2), 
                profit: profit.toFixed(2),
                isPaid: paidStatus 
            };

            records.push(newRecord);
            
            saveItemPrice(item, costJPY, totalSaleTWD, quantity); 

            // æ¸…ç©ºè¼¸å…¥æ¬„ä½ 
            document.getElementById('